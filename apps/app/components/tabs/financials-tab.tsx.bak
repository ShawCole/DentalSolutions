"use client";
import { useSimStore } from "@/lib/store";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Slider } from "@/components/ui/slider";
import { cn } from "@/lib/utils";
import { download, toMonthlyCsv } from "@/lib/export/csv";

export function FinancialsTab() {
    const { assumptions, setAssumptions } = useSimStore();

    return (
        <div className="space-y-6">
            {/* Global Revenue Control */}
            <Card className="bg-white text-zinc-900 border-2 border-zinc-100 shadow-md">
                <CardHeader>
                    <CardTitle className="text-zinc-900 flex items-center justify-between">
                        <span>Global Payment Mix</span>
                        <span className="text-xs font-normal text-zinc-500">Determines the ratio of patients financing vs. paying in full</span>
                    </CardTitle>
                </CardHeader>
                <CardContent>
                    <Slider
                        label="Patient Payment Mix"
                        valueDisplay={`${Math.round(assumptions.financing.financingTakeRatePct * 100)}% Finance / ${Math.round((1 - assumptions.financing.financingTakeRatePct) * 100)}% Full`}
                        min={0} max={100} step={1}
                        value={Math.round(assumptions.financing.financingTakeRatePct * 100)}
                        onChange={(e) => setAssumptions({ financing: { ...assumptions.financing, financingTakeRatePct: Number(e.target.value) / 100 } })}
                    />
                    <div className="mt-2 flex justify-between text-[10px] text-zinc-400 font-bold uppercase tracking-widest px-1">
                        <span>Everybody Finances</span>
                        <span>Everybody Pays In Full</span>
                    </div>
                </CardContent>
            </Card>

            <div className="grid gap-6 md:grid-cols-2">
                {/* Left Column: Revenue Drivers */}
                <div className="space-y-6">
                    <Card>
                        <CardHeader>
                            <CardTitle>Procedure Pricing ($)</CardTitle>
                        </CardHeader>
                        <CardContent className="space-y-6">
                            <div className="space-y-4">
                                <p className="text-xs font-bold uppercase text-zinc-400 tracking-wider">Smile Design (Non-Invasive)</p>
                                <div className="grid grid-cols-3 gap-3">
                                    <div>
                                        <label className="text-[10px] text-zinc-500 block mb-1">Nanotech</label>
                                        <input type="number" className="w-full rounded border px-2 py-1 text-sm bg-zinc-50"
                                            value={assumptions.pricing.smileDesign.nonInvasive.nanotech}
                                            onChange={(e) => {
                                                const val = Number(e.target.value || 0);
                                                setAssumptions({
                                                    pricing: { ...assumptions.pricing, smileDesign: { ...assumptions.pricing.smileDesign, nonInvasive: { ...assumptions.pricing.smileDesign.nonInvasive, nanotech: val } } }
                                                });
                                            }}
                                        />
                                    </div>
                                    <div>
                                        <label className="text-[10px] text-zinc-500 block mb-1">Porcelain</label>
                                        <input type="number" className="w-full rounded border px-2 py-1 text-sm bg-zinc-50"
                                            value={assumptions.pricing.smileDesign.nonInvasive.porcelain}
                                            onChange={(e) => {
                                                const val = Number(e.target.value || 0);
                                                setAssumptions({
                                                    pricing: { ...assumptions.pricing, smileDesign: { ...assumptions.pricing.smileDesign, nonInvasive: { ...assumptions.pricing.smileDesign.nonInvasive, porcelain: val } } }
                                                });
                                            }}
                                        />
                                    </div>
                                    <div>
                                        <label className="text-[10px] text-zinc-500 block mb-1">Cubic Zirconia</label>
                                        <input type="number" className="w-full rounded border px-2 py-1 text-sm bg-zinc-50"
                                            value={assumptions.pricing.smileDesign.nonInvasive.cubicZirconia}
                                            onChange={(e) => {
                                                const val = Number(e.target.value || 0);
                                                setAssumptions({
                                                    pricing: { ...assumptions.pricing, smileDesign: { ...assumptions.pricing.smileDesign, nonInvasive: { ...assumptions.pricing.smileDesign.nonInvasive, cubicZirconia: val } } }
                                                });
                                            }}
                                        />
                                    </div>
                                </div>
                            </div>

                            <div className="space-y-4 pt-4 border-t border-zinc-100">
                                <p className="text-xs font-bold uppercase text-zinc-400 tracking-wider">Smile Design (Invasive)</p>
                                <div className="grid grid-cols-3 gap-3">
                                    <div>
                                        <label className="text-[10px] text-zinc-500 block mb-1">Porcelain</label>
                                        <input type="number" className="w-full rounded border px-2 py-1 text-sm bg-zinc-50"
                                            value={assumptions.pricing.smileDesign.invasive.porcelain}
                                            onChange={(e) => {
                                                const val = Number(e.target.value || 0);
                                                setAssumptions({
                                                    pricing: { ...assumptions.pricing, smileDesign: { ...assumptions.pricing.smileDesign, invasive: { ...assumptions.pricing.smileDesign.invasive, porcelain: val } } }
                                                });
                                            }}
                                        />
                                    </div>
                                    <div>
                                        <label className="text-[10px] text-zinc-500 block mb-1">Pure Porcelain</label>
                                        <input type="number" className="w-full rounded border px-2 py-1 text-sm bg-zinc-50"
                                            value={assumptions.pricing.smileDesign.invasive.porcelainPure}
                                            onChange={(e) => {
                                                const val = Number(e.target.value || 0);
                                                setAssumptions({
                                                    pricing: { ...assumptions.pricing, smileDesign: { ...assumptions.pricing.smileDesign, invasive: { ...assumptions.pricing.smileDesign.invasive, porcelainPure: val } } }
                                                });
                                            }}
                                        />
                                    </div>
                                    <div>
                                        <label className="text-[10px] text-zinc-500 block mb-1">Cubic Zirconia</label>
                                        <input type="number" className="w-full rounded border px-2 py-1 text-sm bg-zinc-50"
                                            value={assumptions.pricing.smileDesign.invasive.cubicZirconia}
                                            onChange={(e) => {
                                                const val = Number(e.target.value || 0);
                                                setAssumptions({
                                                    pricing: { ...assumptions.pricing, smileDesign: { ...assumptions.pricing.smileDesign, invasive: { ...assumptions.pricing.smileDesign.invasive, cubicZirconia: val } } }
                                                });
                                            }}
                                        />
                                    </div>
                                </div>
                            </div>

                            <div className="space-y-4 pt-4 border-t border-zinc-100">
                                <p className="text-xs font-bold uppercase text-zinc-400 tracking-wider">Other Treatments</p>
                                <div className="grid grid-cols-3 gap-3">
                                    <div>
                                        <label className="text-[10px] text-zinc-500 block mb-1">Implant (Mode)</label>
                                        <input type="number" className="w-full rounded border px-2 py-1 text-sm bg-zinc-50"
                                            value={assumptions.pricing.implants.mode}
                                            onChange={(e) => setAssumptions({ pricing: { ...assumptions.pricing, implants: { ...assumptions.pricing.implants, mode: Number(e.target.value || 0) } } })}
                                        />
                                    </div>
                                    <div>
                                        <label className="text-[10px] text-zinc-500 block mb-1">All-in-4 (1 Arc)</label>
                                        <input type="number" className="w-full rounded border px-2 py-1 text-sm bg-zinc-50"
                                            value={assumptions.pricing.allIn4.oneArc}
                                            onChange={(e) => setAssumptions({ pricing: { ...assumptions.pricing, allIn4: { ...assumptions.pricing.allIn4, oneArc: Number(e.target.value || 0) } } })}
                                        />
                                    </div>
                                    <div>
                                        <label className="text-[10px] text-zinc-500 block mb-1">All-in-4 (2 Arcs)</label>
                                        <input type="number" className="w-full rounded border px-2 py-1 text-sm bg-zinc-50"
                                            value={assumptions.pricing.allIn4.twoArcs}
                                            onChange={(e) => setAssumptions({ pricing: { ...assumptions.pricing, allIn4: { ...assumptions.pricing.allIn4, twoArcs: Number(e.target.value || 0) } } })}
                                        />
                                    </div>
                                </div>
                            </div>
                        </CardContent>
                    </Card>

                    <Card>
                        <CardHeader>
                            <CardTitle>Financing Terms</CardTitle>
                        </CardHeader>
                        <CardContent className="space-y-6">
                            <Slider
                                label="Booking Deposit ($)"
                                valueDisplay={`$${assumptions.financing.bookingDeposit.toLocaleString()}`}
                                min={0} max={5000} step={100}
                                value={assumptions.financing.bookingDeposit}
                                onChange={(e) => setAssumptions({ financing: { ...assumptions.financing, bookingDeposit: Number(e.target.value) } })}
                            />
                            <Slider
                                label="Downpayment (%)"
                                valueDisplay={`${Math.round(assumptions.financing.downpaymentPct * 100)}%`}
                                min={20} max={80} step={1}
                                value={Math.round(assumptions.financing.downpaymentPct * 100)}
                                onChange={(e) => setAssumptions({ financing: { ...assumptions.financing, downpaymentPct: Number(e.target.value) / 100 } })}
                            />
                            <Slider
                                label="Term Length (Months)"
                                valueDisplay={`${assumptions.financing.monthsToPay} mo`}
                                min={3} max={24} step={3}
                                value={assumptions.financing.monthsToPay}
                                onChange={(e) => setAssumptions({ financing: { ...assumptions.financing, monthsToPay: Number(e.target.value) as any } })}
                            />
                            <Slider
                                label="Provider Fee (%)"
                                valueDisplay={`${(assumptions.financing.providerFeePct * 100).toFixed(1)}%`}
                                min={0} max={10} step={0.1}
                                value={assumptions.financing.providerFeePct * 100}
                                onChange={(e) => setAssumptions({ financing: { ...assumptions.financing, providerFeePct: Number(e.target.value) / 100 } })}
                            />
                        </CardContent>
                    </Card>
                </div>

                {/* Right Column: Cost Controls */}
                <div className="space-y-6">
                    <Card>
                        <CardHeader>
                            <CardTitle>Material Costs (COGS) ($)</CardTitle>
                        </CardHeader>
                        <CardContent className="space-y-6">
                            <div className="space-y-4">
                                <p className="text-xs font-bold uppercase text-zinc-400 tracking-wider">Smile Design (Non-Invasive)</p>
                                <div className="grid grid-cols-3 gap-3">
                                    <div>
                                        <label className="text-[10px] text-zinc-500 block mb-1">Nanotech</label>
                                        <input type="number" className="w-full rounded border px-2 py-1 text-sm bg-zinc-50"
                                            value={assumptions.variableCosts.perService.smileNonInvasive.nanotech}
                                            onChange={(e) => setAssumptions({ variableCosts: { ...assumptions.variableCosts, perService: { ...assumptions.variableCosts.perService, smileNonInvasive: { ...assumptions.variableCosts.perService.smileNonInvasive, nanotech: Number(e.target.value || 0) } } } })}
                                        />
                                    </div>
                                    <div>
                                        <label className="text-[10px] text-zinc-500 block mb-1">Porcelain</label>
                                        <input type="number" className="w-full rounded border px-2 py-1 text-sm bg-zinc-50"
                                            value={assumptions.variableCosts.perService.smileNonInvasive.porcelain}
                                            onChange={(e) => setAssumptions({ variableCosts: { ...assumptions.variableCosts, perService: { ...assumptions.variableCosts.perService, smileNonInvasive: { ...assumptions.variableCosts.perService.smileNonInvasive, porcelain: Number(e.target.value || 0) } } } })}
                                        />
                                    </div>
                                    <div>
                                        <label className="text-[10px] text-zinc-500 block mb-1">Cubic Zirconia</label>
                                        <input type="number" className="w-full rounded border px-2 py-1 text-sm bg-zinc-50"
                                            value={assumptions.variableCosts.perService.smileNonInvasive.cubicZirconia}
                                            onChange={(e) => setAssumptions({ variableCosts: { ...assumptions.variableCosts, perService: { ...assumptions.variableCosts.perService, smileNonInvasive: { ...assumptions.variableCosts.perService.smileNonInvasive, cubicZirconia: Number(e.target.value || 0) } } } })}
                                        />
                                    </div>
                                </div>
                            </div>

                            <div className="space-y-4 pt-4 border-t border-zinc-100">
                                <p className="text-xs font-bold uppercase text-zinc-400 tracking-wider">Smile Design (Invasive)</p>
                                <div className="grid grid-cols-3 gap-3">
                                    <div>
                                        <label className="text-[10px] text-zinc-500 block mb-1">Porcelain</label>
                                        <input type="number" className="w-full rounded border px-2 py-1 text-sm bg-zinc-50"
                                            value={assumptions.variableCosts.perService.smileInvasive.porcelain}
                                            onChange={(e) => setAssumptions({ variableCosts: { ...assumptions.variableCosts, perService: { ...assumptions.variableCosts.perService, smileInvasive: { ...assumptions.variableCosts.perService.smileInvasive, porcelain: Number(e.target.value || 0) } } } })}
                                        />
                                    </div>
                                    <div>
                                        <label className="text-[10px] text-zinc-500 block mb-1">Pure Porcelain</label>
                                        <input type="number" className="w-full rounded border px-2 py-1 text-sm bg-zinc-50"
                                            value={assumptions.variableCosts.perService.smileInvasive.porcelainPure}
                                            onChange={(e) => setAssumptions({ variableCosts: { ...assumptions.variableCosts, perService: { ...assumptions.variableCosts.perService, smileInvasive: { ...assumptions.variableCosts.perService.smileInvasive, porcelainPure: Number(e.target.value || 0) } } } })}
                                        />
                                    </div>
                                    <div>
                                        <label className="text-[10px] text-zinc-500 block mb-1">Cubic Zirconia</label>
                                        <input type="number" className="w-full rounded border px-2 py-1 text-sm bg-zinc-50"
                                            value={assumptions.variableCosts.perService.smileInvasive.cubicZirconia}
                                            onChange={(e) => setAssumptions({ variableCosts: { ...assumptions.variableCosts, perService: { ...assumptions.variableCosts.perService, smileInvasive: { ...assumptions.variableCosts.perService.smileInvasive, cubicZirconia: Number(e.target.value || 0) } } } })}
                                        />
                                    </div>
                                </div>
                            </div>

                            <div className="space-y-4 pt-4 border-t border-zinc-100">
                                <p className="text-xs font-bold uppercase text-zinc-400 tracking-wider">Other Treatments</p>
                                <div className="grid grid-cols-3 gap-3">
                                    <div>
                                        <label className="text-[10px] text-zinc-500 block mb-1">Implant (Each)</label>
                                        <input type="number" className="w-full rounded border px-2 py-1 text-sm bg-zinc-50"
                                            value={assumptions.variableCosts.perService.implants.perImplant}
                                            onChange={(e) => setAssumptions({ variableCosts: { ...assumptions.variableCosts, perService: { ...assumptions.variableCosts.perService, implants: { perImplant: Number(e.target.value || 0) } } } })}
                                        />
                                    </div>
                                    <div>
                                        <label className="text-[10px] text-zinc-500 block mb-1">All-in-4 (1 Arc)</label>
                                        <input type="number" className="w-full rounded border px-2 py-1 text-sm bg-zinc-50"
                                            value={assumptions.variableCosts.perService.allIn4.oneArc}
                                            onChange={(e) => setAssumptions({ variableCosts: { ...assumptions.variableCosts, perService: { ...assumptions.variableCosts.perService, allIn4: { ...assumptions.variableCosts.perService.allIn4, oneArc: Number(e.target.value || 0) } } } })}
                                        />
                                    </div>
                                    <div>
                                        <label className="text-[10px] text-zinc-500 block mb-1">All-in-4 (2 Arcs)</label>
                                        <input type="number" className="w-full rounded border px-2 py-1 text-sm bg-zinc-50"
                                            value={assumptions.variableCosts.perService.allIn4.twoArcs}
                                            onChange={(e) => setAssumptions({ variableCosts: { ...assumptions.variableCosts, perService: { ...assumptions.variableCosts.perService, allIn4: { ...assumptions.variableCosts.perService.allIn4, twoArcs: Number(e.target.value || 0) } } } })}
                                        />
                                    </div>
                                </div>
                            </div>
                        </CardContent>
                    </Card>

                    <Card>
                        <CardHeader>
                            <CardTitle>Fixed Costs</CardTitle>
                        </CardHeader>
                        <CardContent className="space-y-4">
                            {assumptions.fixedCosts.items.map((it, idx) => (
                                <div key={it.id} className="flex items-center gap-2">
                                    <input
                                        type="text"
                                        className="w-full rounded border px-2 py-1 text-sm bg-zinc-50"
                                        value={it.name}
                                        placeholder="Expense Name"
                                        onChange={(e) => {
                                            const items = assumptions.fixedCosts.items.slice();
                                            items[idx] = { ...items[idx], name: e.target.value };
                                            setAssumptions({ fixedCosts: { items } });
                                        }}
                                    />
                                    <input
                                        type="number"
                                        className="w-32 rounded border px-2 py-1 text-sm text-right"
                                        value={it.amountPerMonth}
                                        onChange={(e) => {
                                            const items = assumptions.fixedCosts.items.slice();
                                            items[idx] = { ...items[idx], amountPerMonth: Number(e.target.value || 0) };
                                            setAssumptions({ fixedCosts: { items } });
                                        }}
                                    />
                                    <button
                                        className="text-zinc-400 hover:text-red-500"
                                        onClick={() => {
                                            const items = assumptions.fixedCosts.items.filter((_, i) => i !== idx);
                                            setAssumptions({ fixedCosts: { items } });
                                        }}
                                    >
                                        ✕
                                    </button>
                                </div>
                            ))}
                            <button
                                className="w-full py-2 text-sm text-zinc-500 border border-dashed rounded hover:bg-zinc-50"
                                onClick={() => {
                                    const items = assumptions.fixedCosts.items.concat({ id: `item-${Date.now()}`, name: "", amountPerMonth: 0 });
                                    setAssumptions({ fixedCosts: { items } });
                                }}
                            >
                                + Add Fixed Cost
                            </button>
                        </CardContent>
                    </Card>

                    <Card>
                        <CardHeader>
                            <CardTitle>Variable Costs</CardTitle>
                        </CardHeader>
                        <CardContent className="space-y-4">
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="text-xs font-medium text-zinc-500">Hotel ($/night)</label>
                                    <input type="number" className="mt-1 w-full rounded border px-2 py-1"
                                        value={assumptions.variableCosts.perClient?.hotelNight ?? 0}
                                        onChange={(e) => setAssumptions({ variableCosts: { ...assumptions.variableCosts, perClient: { ...(assumptions.variableCosts.perClient || {}), hotelNight: Number(e.target.value || 0) } } })}
                                    />
                                </div>
                                <div>
                                    <label className="text-xs font-medium text-zinc-500">Food ($/day)</label>
                                    <input type="number" className="mt-1 w-full rounded border px-2 py-1"
                                        value={assumptions.variableCosts.perClient?.foodDay ?? 0}
                                        onChange={(e) => setAssumptions({ variableCosts: { ...assumptions.variableCosts, perClient: { ...(assumptions.variableCosts.perClient || {}), foodDay: Number(e.target.value || 0) } } })}
                                    />
                                </div>
                            </div>
                        </CardContent>
                    </Card>
                </div>

                {/* Monthly Breakdown: Spans both columns */}
                {(() => {
                    const { lastResult, assumptions } = useSimStore();
                    if (!lastResult) return null;

                    // Use median (p50) for a single realistic simulation run
                    const monthlyData = lastResult.percentiles.p50;

                    return (
                        <Card className="mt-6 md:col-span-2">
                            <CardHeader>
                                <div className="flex items-center justify-between">
                                    <div>
                                        <CardTitle>Turn-by-Turn Monthly Simulation</CardTitle>
                                        <p className="text-xs text-zinc-500 mt-1">Each month shows actual business activity - campaigns running, patients served, cash movements</p>
                                    </div>
                                    <div className="flex items-center gap-4">
                                        <button
                                            className="text-sm font-medium text-blue-600 hover:text-blue-800"
                                            onClick={() => download("simulation_results.csv", toMonthlyCsv(monthlyData))}
                                        >
                                            Export CSV
                                        </button>
                                    </div>
                                </div>
                            </CardHeader>
                            <CardContent>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm text-left">
                                        <thead className="bg-zinc-50 border-b-2 border-zinc-300 text-zinc-600">
                                            <tr>
                                                <th className="p-3 font-semibold sticky left-0 bg-zinc-50 z-10 border-r-2 border-zinc-200">Month</th>
                                                <th className="p-3 font-semibold text-center bg-purple-50 border-r border-purple-200">Active Campaigns</th>
                                                <th className="p-3 font-semibold text-right bg-purple-50 border-r-2 border-purple-200">Ad Spend</th>
                                                <th className="p-3 font-semibold text-right bg-green-50 border-r border-green-200">Patients Served</th>
                                                <th className="p-3 font-semibold text-right bg-green-50 border-r-2 border-green-200">Revenue</th>
                                                <th className="p-3 font-semibold text-right bg-blue-100 border-r-2 border-blue-300">Cash Start</th>
                                                <th className="p-3 font-semibold text-right bg-green-50 border-r border-green-200">Cash In</th>
                                                <th className="p-3 font-semibold text-right text-xs text-zinc-500">↳ Down</th>
                                                <th className="p-3 font-semibold text-right text-xs text-zinc-500 border-r-2 border-green-200">↳ Install</th>
                                                <th className="p-3 font-semibold text-right bg-red-50 border-r border-red-200">Cash Out</th>
                                                <th className="p-3 font-semibold text-right text-xs text-zinc-500">↳ OpEx</th>
                                                <th className="p-3 font-semibold text-right text-xs text-zinc-500 border-r-2 border-red-200">↳ CapEx</th>
                                                <th className="p-3 font-semibold text-right bg-blue-50 border-r border-blue-200 font-bold">Net Flow</th>
                                                <th className="p-3 font-semibold text-right bg-blue-50 font-bold">Cash End</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y">
                                            {monthlyData.map((m: any, i: number) => {
                                                // Determine which campaigns are active this month
                                                const activeCampaigns = assumptions.funnel.savedCampaigns.filter(camp => {
                                                    const start = camp.startMonthIdx || 0;
                                                    const dur = camp.durationMonths;
                                                    return i >= start && (dur === null || i < start + dur);
                                                });

                                                const campaignNames = activeCampaigns.length > 0
                                                    ? activeCampaigns.map(c => c.name).join(", ")
                                                    : "None";

                                                // Calculate cash movements
                                                const cashIn = m.downpaymentCash + m.installmentsCash;
                                                const totalOpEx = m.cashStart - m.cashAfterOverhead;
                                                const cashOut = totalOpEx + m.capex;

                                                // Patient count
                                                const patientCount = m.patientsTotal || 0;

                                                return (
                                                    <tr key={i} className="hover:bg-zinc-50/50">
                                                        <td className="p-3 font-bold text-zinc-900 sticky left-0 bg-white z-10 border-r-2 border-zinc-200">
                                                            M{i + 1}
                                                        </td>

                                                        {/* Campaign Activity */}
                                                        <td className="p-3 text-center text-xs bg-purple-50/30 border-r border-purple-200">
                                                            <span className="font-medium text-purple-700">{activeCampaigns.length}</span>
                                                            <div className="text-[10px] text-zinc-500 mt-0.5 truncate max-w-[120px]" title={campaignNames}>
                                                                {campaignNames}
                                                            </div>
                                                        </td>
                                                        <td className="p-3 text-right font-medium text-purple-700 bg-purple-50/30 border-r-2 border-purple-200">
                                                            ${m.adSpend.toLocaleString(undefined, { maximumFractionDigits: 0 })}
                                                        </td>

                                                        {/* Patient & Revenue */}
                                                        <td className="p-3 text-right font-bold text-green-700 bg-green-50/30 border-r border-green-200">
                                                            {patientCount}
                                                        </td>
                                                        <td className="p-3 text-right font-medium text-green-700 bg-green-50/30 border-r-2 border-green-200">
                                                            ${m.revenue.toLocaleString(undefined, { maximumFractionDigits: 0 })}
                                                        </td>

                                                        {/* Cash Start */}
                                                        <td className="p-3 text-right font-bold text-blue-700 bg-blue-100/40 border-r-2 border-blue-300">
                                                            ${m.cashStart.toLocaleString(undefined, { maximumFractionDigits: 0 })}
                                                        </td>

                                                        {/* Cash Inflows */}
                                                        <td className="p-3 text-right font-bold text-green-700 bg-green-50/30 border-r border-green-200">
                                                            ${cashIn.toLocaleString(undefined, { maximumFractionDigits: 0 })}
                                                        </td>
                                                        <td className="p-3 text-right text-xs text-green-600">
                                                            ${m.downpaymentCash.toLocaleString(undefined, { maximumFractionDigits: 0 })}
                                                        </td>
                                                        <td className="p-3 text-right text-xs text-green-600 border-r-2 border-green-200">
                                                            ${m.installmentsCash.toLocaleString(undefined, { maximumFractionDigits: 0 })}
                                                        </td>

                                                        {/* Cash Outflows */}
                                                        <td className="p-3 text-right font-bold text-red-700 bg-red-50/30 border-r border-red-200">
                                                            -${cashOut.toLocaleString(undefined, { maximumFractionDigits: 0 })}
                                                        </td>
                                                        <td className="p-3 text-right text-xs text-red-600">
                                                            -${totalOpEx.toLocaleString(undefined, { maximumFractionDigits: 0 })}
                                                        </td>
                                                        <td className="p-3 text-right text-xs text-orange-600 border-r-2 border-red-200">
                                                            {m.capex > 0 ? `-$${m.capex.toLocaleString(undefined, { maximumFractionDigits: 0 })}` : '-'}
                                                        </td>

                                                        {/* Net Flow & Cash End */}
                                                        <td className={cn("p-3 text-right font-bold bg-blue-50/30 border-r border-blue-200", m.netCashflow >= 0 ? "text-green-700" : "text-red-700")}>
                                                            {m.netCashflow >= 0 ? "+" : ""}${m.netCashflow.toLocaleString(undefined, { maximumFractionDigits: 0 })}
                                                        </td>
                                                        <td className="p-3 text-right font-bold text-blue-700 bg-blue-50/30">
                                                            ${m.cashOnHand.toLocaleString(undefined, { maximumFractionDigits: 0 })}
                                                        </td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>

                                {/* Legend */}
                                <div className="mt-4 p-4 bg-zinc-50 rounded-lg border border-zinc-200">
                                    <p className="text-xs font-semibold text-zinc-700 mb-2">How to Read This Turn-Based Simulation:</p>
                                    <div className="grid grid-cols-3 gap-3 text-xs text-zinc-600">
                                        <div>
                                            <span className="font-medium text-purple-700">Active Campaigns:</span> Which marketing campaigns are running this month
                                        </div>
                                        <div>
                                            <span className="font-medium text-green-700">Patients Served:</span> Number of patients who completed treatment this month
                                        </div>
                                        <div>
                                            <span className="font-medium text-green-700">Revenue:</span> Total service value delivered (accrual basis)
                                        </div>
                                        <div>
                                            <span className="font-medium text-blue-700">Cash Start:</span> Your cash position at the beginning of the month
                                        </div>
                                        <div>
                                            <span className="font-medium text-green-700">Cash In:</span> Actual money received (downpayments + installments)
                                        </div>
                                        <div>
                                            <span className="font-medium text-red-700">Cash Out:</span> Actual money spent (OpEx + CapEx)
                                        </div>
                                        <div>
                                            <span className="font-medium text-blue-700">Net Flow:</span> Cash In - Cash Out (monthly profit/loss)
                                        </div>
                                        <div>
                                            <span className="font-medium text-blue-700">Cash End:</span> Your cash position at month end (becomes next month's Cash Start)
                                        </div>
                                        <div>
                                            <span className="font-medium text-zinc-600">Formula:</span> Cash Start + Cash In - Cash Out = Cash End
                                        </div>
                                    </div>
                                </div>
                            </CardContent>
                        </Card>
                    );
                })()}
            </div>
        </div>
    );
}
{
    (() => {
        const { lastResult } = useSimStore();
        if (!lastResult) return null;

        // Use median (p50) instead of mean for a more realistic month-by-month view
        const monthlyData = lastResult.percentiles.p50;

        return (
            <Card className="mt-6 md:col-span-2">
                <CardHeader>
                    <div className="flex items-center justify-between">
                        <CardTitle>Monthly Breakdown (Median Run)</CardTitle>
                        <div className="flex items-center gap-4">
                            <button
                                className="text-sm font-medium text-blue-600 hover:text-blue-800"
                                onClick={() => download("simulation_results.csv", toMonthlyCsv(monthlyData))}
                            >
                                Export CSV
                            </button>
                            <div className="text-xs text-zinc-400">
                                For day-by-day tracking, see the <span className="text-blue-600 font-medium">Ledger tab</span>
                            </div>
                        </div>
                    </div>
                </CardHeader>
                <CardContent>
                    <div className="overflow-x-auto">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-zinc-50 border-b text-zinc-500">
                                <tr>
                                    <th className="p-3 font-medium sticky left-0 bg-zinc-50 z-10">Month</th>
                                    <th className="p-3 font-medium text-right bg-blue-100 border-l-2 border-blue-300">Cash Start</th>
                                    <th className="p-3 font-medium text-right bg-green-50 border-l-2 border-green-200">Cash In</th>
                                    <th className="p-3 font-medium text-right text-xs text-zinc-400">↳ Downpay</th>
                                    <th className="p-3 font-medium text-right text-xs text-zinc-400">↳ Install</th>
                                    <th className="p-3 font-medium text-right bg-red-50 border-l-2 border-red-200">Cash Out</th>
                                    <th className="p-3 font-medium text-right text-xs text-zinc-400">↳ Ad Spend</th>
                                    <th className="p-3 font-medium text-right text-xs text-zinc-400">↳ Commis.</th>
                                    <th className="p-3 font-medium text-right text-xs text-zinc-400">↳ Salaries</th>
                                    <th className="p-3 font-medium text-right text-xs text-zinc-400">↳ Materials</th>
                                    <th className="p-3 font-medium text-right text-xs text-zinc-400">↳ Fixed</th>
                                    <th className="p-3 font-medium text-right bg-orange-50 border-l-2 border-orange-200">CapEx</th>
                                    <th className="p-3 font-medium text-right bg-blue-50 border-l-2 border-blue-200 font-bold">Net Flow</th>
                                    <th className="p-3 font-medium text-right bg-blue-50 font-bold">Cash End</th>
                                    <th className="p-3 font-medium text-right bg-zinc-100 border-l-2 border-zinc-300 text-xs text-zinc-500">Revenue (Accrual)</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y">
                                {monthlyData.map((m: any, i: number) => {
                                    // Calculate components
                                    const cashIn = m.downpaymentCash + m.installmentsCash;
                                    const totalOpEx = m.cashStart - m.cashAfterOverhead;
                                    const materialsCost = totalOpEx - m.adSpend - m.commissions - m.salaries;

                                    // Fixed costs (from assumptions)
                                    const fixedCosts = assumptions.fixedCosts.items.reduce((sum, item) => sum + item.amountPerMonth, 0);
                                    const variableOpEx = materialsCost - fixedCosts;

                                    const cashOut = m.adSpend + m.commissions + m.salaries + materialsCost;

                                    return (
                                        <tr key={i} className="hover:bg-zinc-50/50">
                                            <td className="p-3 font-medium text-zinc-900 sticky left-0 bg-white z-10">M{i + 1}</td>

                                            {/* Cash Start */}
                                            <td className="p-3 text-right font-medium text-blue-700 bg-blue-100/30 border-l-2 border-blue-300">
                                                ${m.cashStart.toLocaleString(undefined, { maximumFractionDigits: 0 })}
                                            </td>

                                            {/* Cash Inflows */}
                                            <td className="p-3 text-right font-bold text-green-700 bg-green-50/30 border-l-2 border-green-200">
                                                ${cashIn.toLocaleString(undefined, { maximumFractionDigits: 0 })}
                                            </td>
                                            <td className="p-3 text-right text-green-600 text-xs">
                                                ${m.downpaymentCash.toLocaleString(undefined, { maximumFractionDigits: 0 })}
                                            </td>
                                            <td className="p-3 text-right text-green-600 text-xs">
                                                ${m.installmentsCash.toLocaleString(undefined, { maximumFractionDigits: 0 })}
                                            </td>

                                            {/* Cash Outflows */}
                                            <td className="p-3 text-right font-bold text-red-700 bg-red-50/30 border-l-2 border-red-200">
                                                -${cashOut.toLocaleString(undefined, { maximumFractionDigits: 0 })}
                                            </td>
                                            <td className="p-3 text-right text-red-600 text-xs">
                                                -${m.adSpend.toLocaleString(undefined, { maximumFractionDigits: 0 })}
                                            </td>
                                            <td className="p-3 text-right text-red-600 text-xs">
                                                -${m.commissions.toLocaleString(undefined, { maximumFractionDigits: 0 })}
                                            </td>
                                            <td className="p-3 text-right text-red-600 text-xs">
                                                -${m.salaries.toLocaleString(undefined, { maximumFractionDigits: 0 })}
                                            </td>
                                            <td className="p-3 text-right text-red-600 text-xs">
                                                -${variableOpEx.toLocaleString(undefined, { maximumFractionDigits: 0 })}
                                            </td>
                                            <td className="p-3 text-right text-red-600 text-xs">
                                                -${fixedCosts.toLocaleString(undefined, { maximumFractionDigits: 0 })}
                                            </td>

                                            {/* CapEx */}
                                            <td className="p-3 text-right text-orange-600 font-medium bg-orange-50/30 border-l-2 border-orange-200">
                                                {m.capex > 0 ? `-$${m.capex.toLocaleString(undefined, { maximumFractionDigits: 0 })}` : '-'}
                                            </td>

                                            {/* Net Flow & Cash Position */}
                                            <td className={cn("p-3 text-right font-bold bg-blue-50/30 border-l-2 border-blue-200", m.netCashflow >= 0 ? "text-green-700" : "text-red-700")}>
                                                {m.netCashflow >= 0 ? "+" : ""}${m.netCashflow.toLocaleString(undefined, { maximumFractionDigits: 0 })}
                                            </td>
                                            <td className="p-3 text-right font-bold text-blue-700 bg-blue-50/30">
                                                ${m.cashOnHand.toLocaleString(undefined, { maximumFractionDigits: 0 })}
                                            </td>

                                            {/* Revenue (for reference) */}
                                            <td className="p-3 text-right text-zinc-500 text-xs bg-zinc-50 border-l-2 border-zinc-300">
                                                ${m.revenue.toLocaleString(undefined, { maximumFractionDigits: 0 })}
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>

                    {/* Legend */}
                    <div className="mt-4 p-4 bg-zinc-50 rounded-lg border border-zinc-200">
                        <p className="text-xs font-semibold text-zinc-700 mb-2">How to Read This Table:</p>
                        <div className="grid grid-cols-2 gap-2 text-xs text-zinc-600">
                            <div><span className="font-medium text-green-700">Cash In:</span> Money that actually hit your bank account (downpayments + installment payments)</div>
                            <div><span className="font-medium text-red-700">Cash Out:</span> Money that left your bank account (all operating expenses)</div>
                            <div><span className="font-medium text-orange-700">CapEx:</span> Equipment purchases (chairs, X-ray, tomography)</div>
                            <div><span className="font-medium text-blue-700">Net Flow:</span> Cash In - Cash Out - CapEx (your monthly profit/loss)</div>
                            <div><span className="font-medium text-blue-700">Cash End:</span> Your total cash position at month end</div>
                            <div><span className="font-medium text-zinc-500">Revenue (Accrual):</span> For accounting - may not match cash timing due to financing</div>
                        </div>
                    </div>
                </CardContent>
            </Card>
        );
    })()
}
            </div >
        </div >
    );
}
